#=

=#

#########################################################################################

using DrWatson
@quickactivate "semester8"

using CairoMakie
using Statistics:mean

include(srcdir("article1_module.jl"))
include(srcdir("misc.jl"))
include(srcdir("plotting_tools.jl"))

using .article1

#########################################################################################

# function init_cond(i, i_max)
#     if i ≤ i_max/2
#         return 1
#     else
#         if iseven(i)
#             return 0
#         else
#             return 1
#         end
#     end
# end

#########################################################################################

N_elements = 100
d = 0.006
J = 0.17

φ_mode = "zero" # "random", "zero", "синфазно", "противофазно"

t_start, t_end, t_N = 0.0, 1e4, 1000

frames_N = 500

periods_to_avg = 10000

#########################################################################################

# initial_pattern = Bool.(init_cond.(1:N_elements, N_elements))
# init_points = article1.φ_mode_to_init_points(φ_mode, initial_pattern)

# u₀ = [init_points[i][1] for i in eachindex(init_points)]
# v₀ = [init_points[i][2] for i in eachindex(init_points)]
# U₀ = [u₀..., v₀...]

# после инегрирования на 5e7 при J=0.0
U₀ = [1.1682268485662508, 1.1773156723650622, 1.1826412150019712, 1.187718499629531, 1.1925394014922264, 1.1971247704824233, 1.2014793941586972, 1.204050427750556, 0.2160801083911585, -1.0430791226378877, -1.089791188826148, -1.107149442222849, -1.12028191608257, -1.1311937809977513, -1.1406110458226688, -1.1489692268793714, -1.156474163254868, -1.1633027970418288, -1.1695606895903856, -1.1753392650269705, -1.1806949739527002, -1.1856811376453746, -1.1903346281715799, -1.1946986581474304, -1.1988234370233648, -1.2027200403751184, -1.205042313963595, -0.14959182167559248, 1.0339871369852305, 1.0834661286066813, 1.100650587406663, 1.1133102398064483, 1.1236357955086709, 1.1323116229707175, 1.1361463729522632, 1.1301232228622315, 1.1204650108460592, 1.1085848192713996, 1.092891712483836, 1.0577636226319156, 0.07241997047766631, -1.204155430536763, -1.2017466912171066, -1.1972962192347927, -1.1926660590319864, -1.1878633466609794, -1.1828581293517264, -1.1776384002441667, -1.1721645697876444, -1.1663583140658542, -1.1561776628225906, 0.3454725024909451, -1.142233758070867, 0.3681099551948506, 1.1932071172753949, 0.2093903875438077, 1.1294359039434914, -0.3098756563761899, -1.1841153555173989, -0.144182024126644, -1.0905388641284726, 0.1948442395407835, 1.1618735979574883, -0.14781328933759388, -1.1987804401284672, -0.22527054320975506, -1.1308475856139488, 0.3126156473032723, 1.182369189960308, 0.11467797357529469, 1.0979304864161883, -0.24923813256662472, -1.1697737386974136, 0.22409646524951937, -1.0174604362169817, 0.13135580270085212, 1.1576459246907207, -0.37310584022822446, -0.5291648742657339, 0.2827989155637674, -1.0911849199309787, 0.008553841605034324, -1.1760012208157031, -0.28819345375350036, 1.126788880019886, 0.24028757621898658, 1.195638100636322, 0.22175714301020505, -1.1557944864821568, -0.16254343138890323, 0.7965150787391679, -0.3294531881589961, 1.1651718063872802, 0.2045603271152136, -1.077956816796424, -0.03567010053467117, -1.1756996364656396, -0.2667095248295823, 1.1054842520982473, -0.34620853568479015, -0.014258936977291975, -0.030150437321325902, -0.04602435689010197, -0.0621168654398106, -0.07827422181681391, -0.09446170528484076, -0.11060684927564754, -0.12666272396138592, -0.13861615853630369, -0.13034839196910775, -0.11597861489230257, -0.10117052705720177, -0.08600834173529316, -0.07051482015029321, -0.054825907007001705, -0.03896015402635918, -0.023055332956556453, -0.00714052566211904, 0.008713389877326262, 0.024480737267445374, 0.04010121484852812, 0.05554775036068687, 0.07077721380166944, 0.08579588974048794, 0.10066625326762661, 0.11535263666607579, 0.12985016989251832, 0.13975161444774736, 0.13258840671277938, 0.12013686828182607, 0.10739662453549469, 0.09451144262151209, 0.08154086187659607, 0.06874815445304128, 0.062491767860079844, 0.07214635515932333, 0.08577071813324168, 0.09968709961918519, 0.11374818156806568, 0.12787128036140807, 0.13844432701776738, 0.128231119686658, 0.1116305806725468, 0.09508245703695876, 0.0787101301079498, 0.06258940054705511, 0.046692695904025895, 0.03106462410688753, 0.015680747416137817, 0.00046815439566369753, -0.014773910093852798, -0.023375840695644443, -0.03390656216648914, -0.009371449864219467, -0.09143108891901112, 0.02072942229500395, 0.059037834482327085, -9.162681127497104e-5, 0.062072123582439645, -0.02650406230443766, -0.10218060153326888, 0.01134792883528617, -0.003048056143614928, -0.0026115946100540707, 0.11266698410649849, -0.01775879293506435, -0.05694078118432856, -0.00031871011946222873, -0.05679642690526136, 0.027209071597916856, 0.0958186615952459, -0.007367759528234006, 0.023110354364943905, -0.02633914628763378, -0.12412749148531288, 0.013835392974014798, 0.005103826049447926, 0.01873587674658808, 0.1315809243265107, -0.0020276048411550862, -0.10030405590741721, -0.027752259965681304, 0.038756605703206735, -0.002967168691806878, 0.06329507752105877, 0.02053595270031691, -0.10074013409599739, -0.01891485631511632, -0.010418193067688182, -0.013099035682179933, 0.1280025413138169, 0.023951477503120683, -0.012170031548480153, 0.010866446708881618, -0.1094971891879651, -0.027450925321314983, 0.037766057995992613, -0.005593233943884243, 0.08590042740245397, 0.02177780897855122]

# после инегрирования на 2e6 при J=0.1
# U₀ = [1.1774657409221743, 1.1829211789781602, 1.186190970133648, 1.1894531409060605, 1.1923776811551918, 1.1955445398308397, 1.198608525283011, 1.2017189284552783, 1.2048422535679786, 1.2076758921214275, -0.2693128126092275, -1.0599091912912733, -1.092458768484512, -1.1099001317466892, -1.123031575932715, -1.1338014254195896, -1.1433242045827103, -1.1519010555577205, -1.1596185849914464, -1.1666023530150704, -1.1731734648806647, -1.179158808185608, -1.1847639618002692, -1.1901451292791718, -1.195226740767717, -1.200134106112274, -1.2032055696477342, -0.29385996149234267, 1.041794293311426, 1.0843524201057946, 1.0746767271844753, 0.7493875581533608, -1.1412337638324197, -1.202143378316419, -1.197605378606065, -1.1926470456565514, -1.1874657269260838, -1.1822750278928615, -1.1768201932372087, -1.1711576390677003, -1.1654827333857445, -1.1597480506542277, -1.1537412536748237, -1.1472332839060777, -1.1401188001715201, -1.1326826698026535, -1.124842257504861, -1.1160696800653496, -1.1050586862952267, -1.090919218586505, -1.0606632195435626, -0.27474773363698635, 1.1113554912657746, -0.28000857852875055, -1.1721372831806947, 0.2691957334813039, 1.173888778654141, 0.25274012983385974, -1.1551066625934745, 0.1796379007634237, 1.1564980094101145, 0.05547297285816988, -1.19123722719283, -0.2694577799021185, -1.1833988576207186, -0.24348009966301412, 1.063077746875258, -0.23258036282019984, -1.0892821827680728, 0.2522413766601496, -1.186644583856297, 0.3480438449747383, 1.1975360848306842, -0.08676050387223583, 1.0617974649232345, 0.18509998772399575, 1.1962161543233942, 0.34199145745119064, -1.1854779944063294, 0.19069316130866112, 1.1670482541278724, 0.28381594649906583, 0.1642519071451805, 0.3277499414072256, 1.1776034277619616, 0.2662801197048123, 1.1669415855458087, 0.13599892508893538, -1.1221036816356178, 0.10798307294915216, 1.1551824098451564, 0.1700831322642666, -1.1322473965714204, -0.26493296577251774, 1.1047272480732115, -0.19044625974574209, 1.2039097301889918, 0.32687183792543734, -1.191041046011035, 0.2348597527549092, -0.03621633140962514, -0.04693148337277451, -0.05720672664888094, -0.06786114636576772, -0.07774425941109012, -0.08881861516382727, -0.0999005142083709, -0.11153161280612629, -0.1236090045348932, -0.13602009037360047, -0.14037419995772274, -0.12857501073045075, -0.11422617246529754, -0.09837812005870544, -0.08243377615222594, -0.06645564603496101, -0.049935866056192164, -0.0329861073266439, -0.01594451045121503, 0.001023721708881547, 0.01840593495209766, 0.035485729441747334, 0.05260727353849319, 0.07011162717094496, 0.08763414155801727, 0.10551498515853573, 0.1228687640769319, 0.13647209245750108, 0.12981029633111457, 0.11931937331181697, 0.12387870782444205, 0.1359171287682371, 0.13159307207411094, 0.1138151186190016, 0.09617988688334492, 0.07861592277149229, 0.06126135067146661, 0.04486707034569031, 0.028665568030442158, 0.012920681037940208, -0.001801298733123063, -0.0156463092953306, -0.02908259498121642, -0.04246420103150243, -0.0557625944399764, -0.06825067872325478, -0.07994525551606647, -0.09135263695053482, -0.10336790032388433, -0.1153516775159992, -0.12638977412054664, -0.004511504073207161, 0.07993002456782193, -0.00475369086102204, 0.029567538484679606, 0.004102977721388205, -0.03140167105053379, 0.00581621643566773, -0.009654746258958439, 0.010148996837939737, 0.010523343252782896, 0.013509232851015629, 0.0868167421681022, -0.0198816009858739, 0.059445039058750926, -0.009047106784088226, 0.11385665484512394, -0.009449360345854647, -0.10341235111433475, -0.007984475506608402, 0.07645073068103071, -0.006914162486216479, -0.10880029667988111, -0.0039433620694958454, 0.11728193230376079, -0.00656098048042113, -0.10245310382319305, -0.005769316825498175, 0.07229808497517635, 0.009789152615161813, -0.013376847922831454, 0.014091819453613437, 0.13489330857579598, 0.00786680997547541, -0.041551468324577054, 0.018508001616175808, -0.013542624521499241, 0.011270642403094408, -0.0687279405251688, 0.011364694781226325, 0.013689661630136636, 0.01054626217590988, -0.05591938678371794, -0.006156991187631192, 0.08742731451336942, -0.004294655784604015, -0.12783467509657445, -0.007609756833403252, 0.09079065587849909, 0.007358775019417085]

t_spans = [(t_start+t_end*(i-1), t_start+t_end*(i)) for i in 1:frames_N]

U₀_tmp = deepcopy(U₀)

#########################################################################################

Δtₙ = [Float64[] for i in 1:N_elements]

t_timer = time()
Δt_to_avg = Float64[]

for i in eachindex(t_spans)
    global U₀_tmp, t_timer
    Δt_timer_curr = time()-t_timer
    push!(Δt_to_avg, Δt_timer_curr)
    t_timer = time()
    eta_curr = (frames_N - i)*mean(Δt_to_avg)
    println("$i/$(frames_N): Δt=$(round(Δt_timer_curr, digits=5)), eta=$(round(eta_curr, digits=5))")
        

    t_span = t_spans[i]
    
    sol = article1.moded_integrate_multiple_elements(U₀_tmp, t_span, d, N_elements, J; saveat=range(t_span..., t_N))
    sol_t = sol.t
    uᵢ = [sol[i,:] for i in 1:N_elements]
    vᵢ = [sol[N_elements+i,:] for i in 1:N_elements]

    if i == length(t_spans)
        println("Конечное состояние:\n$(sol[:,end])")
    end

    U₀_tmp = sol[:,end]

    ωᵢ = zeros(N_elements)
    for j in 1:N_elements
        tₙ_curr = passing_through_zero_positive_t(uᵢ[j], sol_t)
        append!(Δtₙ[j], diff(tₙ_curr))
        # ωᵢ[j] = 1/mean(last(Δtₙ[j], periods_to_avg))
        ωᵢ[j] = 1/mean(Δtₙ[j])
    end

    φᵢₜ = zeros(N_elements, t_N)
    for t in 1:t_N
        curr_φ₁ = 0.0
        for i in 1:N_elements
            if i == 1
                curr_φ₁ = calc_phase(uᵢ[i], sol_t, range(t_span..., t_N)[t])
                φᵢₜ[i, t] = 0.0
            else
                φᵢₜ[i, t] = calc_phase(uᵢ[i], sol_t, range(t_span..., t_N)[t]) - curr_φ₁
            end
        end
    end

    φᵢₜ = rem2pi.(φᵢₜ, RoundNearest)

    ###

    fig = Figure(size=(1000, 700))
    ax1 = beautiful_Axis(fig[1, 1], 
        title="Зависимость средней частоты элементов цепочки от номера элемента; N=$(N_elements), d=$(d), J=$J", 
        xlabel="i", ylabel="⟨ωᵢ⟩"
    )
    ax2 = beautiful_Axis(fig[2, 1], 
        title="Зависимость фазы элементов цепочки от времени", 
        xlabel="t", ylabel="i"
    )

    vlines!(ax1, 0.0, color=:black)
    hlines!(ax1, 0.0, color=:black)

    scatter!(ax1, 1:N_elements, ωᵢ, color=:blue)

    heatmap!(ax2, range(t_span..., t_N), 1:N_elements, transpose(φᵢₜ)) 
    limits!(ax1, nothing, nothing, 0.0, 0.0035)
    limits!(ax2, t_span..., nothing, nothing)

    Colorbar(fig[2, 2], limits = (-π,π), flipaxis = false)

    # axislegend(ax1, position=:rb) # (l, r, c), (b, t, c)
    save_path = plotsdir("20-moded_TSDs", "20-moded_TSDs_$(lpad(i,3,"0")).png")
    save(save_path, fig, px_per_unit=2)
end

#########################################################################################