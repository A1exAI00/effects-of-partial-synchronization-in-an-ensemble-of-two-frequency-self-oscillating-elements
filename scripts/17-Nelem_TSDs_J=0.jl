#=
Цель программы: показать химерное состояние для цепочки из N_elements=1000 элементов.

TODO: уточнить описание программы, что здесь зависимость конечной фазы от параметра d
TODO: пофиксить этот ужас с интексами
=#

#########################################################################################

using DrWatson
@quickactivate "semester8"

using CairoMakie
using Statistics:mean

include(srcdir("article1_module.jl"))
include(srcdir("misc.jl"))
include(srcdir("plotting_tools.jl"))

using .article1

#########################################################################################

savedir = joinpath("tmp", "17-Nelem_TSDs_J=0")
if !(ispath(savedir)) mkpath(plotsdir(savedir)) end

#########################################################################################

function init_cond(i, i_max)
    if i ≤ i_max/2
        return 1
    else
        if iseven(i)
            return 0
        else
            return 1
        end
    end
end

#########################################################################################

N_elements = 100
d = 0.006

φ_mode = "zero" # "random", "zero", "синфазно", "противофазно"

t_start, t_end, t_N = 0.0, 1e4, 1000

frames_N = 100

periods_to_avg = 10000

#########################################################################################

initial_pattern = Bool.(init_cond.(1:N_elements, N_elements))
init_points = article1.φ_mode_to_init_points(φ_mode, initial_pattern)

u₀ = [init_points[i][1] for i in eachindex(init_points)]
v₀ = [init_points[i][2] for i in eachindex(init_points)]
U₀ = [u₀..., v₀...]

# после инегрирования на 5e7
U₀ = [1.1682268485662508, 1.1773156723650622, 1.1826412150019712, 1.187718499629531, 1.1925394014922264, 1.1971247704824233, 1.2014793941586972, 1.204050427750556, 0.2160801083911585, -1.0430791226378877, -1.089791188826148, -1.107149442222849, -1.12028191608257, -1.1311937809977513, -1.1406110458226688, -1.1489692268793714, -1.156474163254868, -1.1633027970418288, -1.1695606895903856, -1.1753392650269705, -1.1806949739527002, -1.1856811376453746, -1.1903346281715799, -1.1946986581474304, -1.1988234370233648, -1.2027200403751184, -1.205042313963595, -0.14959182167559248, 1.0339871369852305, 1.0834661286066813, 1.100650587406663, 1.1133102398064483, 1.1236357955086709, 1.1323116229707175, 1.1361463729522632, 1.1301232228622315, 1.1204650108460592, 1.1085848192713996, 1.092891712483836, 1.0577636226319156, 0.07241997047766631, -1.204155430536763, -1.2017466912171066, -1.1972962192347927, -1.1926660590319864, -1.1878633466609794, -1.1828581293517264, -1.1776384002441667, -1.1721645697876444, -1.1663583140658542, -1.1561776628225906, 0.3454725024909451, -1.142233758070867, 0.3681099551948506, 1.1932071172753949, 0.2093903875438077, 1.1294359039434914, -0.3098756563761899, -1.1841153555173989, -0.144182024126644, -1.0905388641284726, 0.1948442395407835, 1.1618735979574883, -0.14781328933759388, -1.1987804401284672, -0.22527054320975506, -1.1308475856139488, 0.3126156473032723, 1.182369189960308, 0.11467797357529469, 1.0979304864161883, -0.24923813256662472, -1.1697737386974136, 0.22409646524951937, -1.0174604362169817, 0.13135580270085212, 1.1576459246907207, -0.37310584022822446, -0.5291648742657339, 0.2827989155637674, -1.0911849199309787, 0.008553841605034324, -1.1760012208157031, -0.28819345375350036, 1.126788880019886, 0.24028757621898658, 1.195638100636322, 0.22175714301020505, -1.1557944864821568, -0.16254343138890323, 0.7965150787391679, -0.3294531881589961, 1.1651718063872802, 0.2045603271152136, -1.077956816796424, -0.03567010053467117, -1.1756996364656396, -0.2667095248295823, 1.1054842520982473, -0.34620853568479015, -0.014258936977291975, -0.030150437321325902, -0.04602435689010197, -0.0621168654398106, -0.07827422181681391, -0.09446170528484076, -0.11060684927564754, -0.12666272396138592, -0.13861615853630369, -0.13034839196910775, -0.11597861489230257, -0.10117052705720177, -0.08600834173529316, -0.07051482015029321, -0.054825907007001705, -0.03896015402635918, -0.023055332956556453, -0.00714052566211904, 0.008713389877326262, 0.024480737267445374, 0.04010121484852812, 0.05554775036068687, 0.07077721380166944, 0.08579588974048794, 0.10066625326762661, 0.11535263666607579, 0.12985016989251832, 0.13975161444774736, 0.13258840671277938, 0.12013686828182607, 0.10739662453549469, 0.09451144262151209, 0.08154086187659607, 0.06874815445304128, 0.062491767860079844, 0.07214635515932333, 0.08577071813324168, 0.09968709961918519, 0.11374818156806568, 0.12787128036140807, 0.13844432701776738, 0.128231119686658, 0.1116305806725468, 0.09508245703695876, 0.0787101301079498, 0.06258940054705511, 0.046692695904025895, 0.03106462410688753, 0.015680747416137817, 0.00046815439566369753, -0.014773910093852798, -0.023375840695644443, -0.03390656216648914, -0.009371449864219467, -0.09143108891901112, 0.02072942229500395, 0.059037834482327085, -9.162681127497104e-5, 0.062072123582439645, -0.02650406230443766, -0.10218060153326888, 0.01134792883528617, -0.003048056143614928, -0.0026115946100540707, 0.11266698410649849, -0.01775879293506435, -0.05694078118432856, -0.00031871011946222873, -0.05679642690526136, 0.027209071597916856, 0.0958186615952459, -0.007367759528234006, 0.023110354364943905, -0.02633914628763378, -0.12412749148531288, 0.013835392974014798, 0.005103826049447926, 0.01873587674658808, 0.1315809243265107, -0.0020276048411550862, -0.10030405590741721, -0.027752259965681304, 0.038756605703206735, -0.002967168691806878, 0.06329507752105877, 0.02053595270031691, -0.10074013409599739, -0.01891485631511632, -0.010418193067688182, -0.013099035682179933, 0.1280025413138169, 0.023951477503120683, -0.012170031548480153, 0.010866446708881618, -0.1094971891879651, -0.027450925321314983, 0.037766057995992613, -0.005593233943884243, 0.08590042740245397, 0.02177780897855122]

# после интегрирования 1e8
# U₀ = []

t_spans = [(t_start+t_end*(i-1), t_start+t_end*(i)) for i in 1:frames_N]

U₀_tmp = deepcopy(U₀)

#########################################################################################

Δtₙ = [Float64[] for i in 1:N_elements]

t_timer = time()
Δt_to_avg = Float64[]

for i in eachindex(t_spans)
    global U₀_tmp, t_timer
    Δt_timer_curr = time()-t_timer
    push!(Δt_to_avg, Δt_timer_curr)
    t_timer = time()
    eta_curr = round((frames_N - i)*mean(Δt_to_avg), digits=5)
    println("$i/$(frames_N): Δt=$(round(Δt_timer_curr, digits=5)), eta=$eta_curr")
        

    t_span = t_spans[i]
    
    sol = article1.integrate_multiple_elements(U₀_tmp, t_span, d, N_elements; saveat=range(t_span..., t_N))
    sol_t = sol.t
    uᵢ = [sol[i,:] for i in 1:N_elements]
    vᵢ = [sol[N_elements+i,:] for i in 1:N_elements]

    if i == length(t_spans)
        println("Конечное состояние:\n$(sol[:,end])")
    end

    U₀_tmp = sol[:,end]

    ωᵢ = zeros(N_elements)
    for j in 1:N_elements
        tₙ_curr = passing_through_zero_positive_t(uᵢ[j], sol_t)
        append!(Δtₙ[j], diff(tₙ_curr))
        # ωᵢ[j] = 1/mean(last(Δtₙ[j], periods_to_avg))
        ωᵢ[j] = 1/mean(Δtₙ[j])
    end

    φᵢₜ = zeros(N_elements, t_N)
    for t in 1:t_N
        curr_φ₁ = 0.0
        for i in 1:N_elements
            if i == 1
                curr_φ₁ = calc_phase(uᵢ[i], sol_t, range(t_span..., t_N)[t])
                φᵢₜ[i, t] = 0.0
            else
                φᵢₜ[i, t] = calc_phase(uᵢ[i], sol_t, range(t_span..., t_N)[t]) - curr_φ₁
            end
        end
    end

    φᵢₜ = rem2pi.(φᵢₜ, RoundNearest)

    ###

    fig = Figure(size=(1000, 700))

    ax1_maintitle = "Зависимость средней частоты элементов цепочки от номера элемента"
    ax1_subtitle = "N=$(N_elements), d=$(d), φ-$φ_mode"
    ax1 = beautiful_Axis(fig[1, 1], 
        title=join(ax1_maintitle, ax1_subtitle, "\n"), 
        xlabel="i", ylabel="⟨ωᵢ⟩"
    )
    ax2 = beautiful_Axis(fig[2, 1], 
        title="Зависимость фазы элементов цепочки от времени", 
        xlabel="t", ylabel="i"
    )

    vlines!(ax1, 0.0, color=:black)
    hlines!(ax1, 0.0, color=:black)

    scatter!(ax1, 1:N_elements, ωᵢ, color=:blue)

    heatmap!(ax2, range(t_span..., t_N), 1:N_elements, transpose(φᵢₜ)) 
    limits!(ax1, nothing, nothing, 0.0, 0.0035)
    limits!(ax2, t_span..., nothing, nothing)

    Colorbar(fig[2, 2], limits = (-π,π), flipaxis = false)

    # axislegend(ax1, position=:rb) # (l, r, c), (b, t, c)
    savepath = plotsdir(savedir, "17-Nelem_TSDs_J=0_$(lpad(i,3,"0")).png")
    save(savepath, fig, px_per_unit=2)
end

#########################################################################################